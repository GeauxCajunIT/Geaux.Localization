@using Geaux.Localization.SampleBlazor.Services
@inject TranslationAdminService Admin
@inject ISnackbar Snackbar

<MudDialog @bind-Visible="Visible">
    <DialogContent>
        <MudText Typo="Typo.h6">Import Translations</MudText>
        <MudText Typo="Typo.body2" Class="mb-2">
            CSV columns: Key,Culture,TenantId,Value
        </MudText>

        <InputFile OnChange="OnFileSelected" />
        <MudText Class="mt-2">@_status</MudText>

        @if (_preview.Any())
        {
            <MudTable Items="_preview" Dense="true" Class="mt-3">
                <HeaderContent>
                    <MudTh>Key</MudTh>
                    <MudTh>Culture</MudTh>
                    <MudTh>Tenant</MudTh>
                    <MudTh>Value</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Key</MudTd>
                    <MudTd>@context.Culture</MudTd>
                    <MudTd>@(context.TenantId ?? "(global)")</MudTd>
                    <MudTd>@context.Value</MudTd>
                </RowTemplate>
            </MudTable>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Import" Color="Color.Primary">Import</MudButton>
        <MudButton OnClick="@(() => Visible = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public EventCallback OnImported { get; set; }

    private string? _text;
    private string? _status;
    private List<TranslationAdminService.ImportPreviewRow> _preview = new();

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        using var reader = new StreamReader(file.OpenReadStream(5_000_000));
        _text = await reader.ReadToEndAsync();

        if (file.Name.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
            _preview = Admin.ParsePreviewCsv(_text);
        else if (file.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
            _preview = Admin.ParsePreviewJson(_text);
        else
            _status = "Unsupported file type.";
    }

    private async Task Import()
    {
        if (string.IsNullOrWhiteSpace(_text))
            return;

        await using var ms =
            new MemoryStream(System.Text.Encoding.UTF8.GetBytes(_text));

        try
        {
            if (_text.TrimStart().StartsWith("{") || _text.TrimStart().StartsWith("["))
                await Admin.ImportJsonAsync(ms);
            else
                await Admin.ImportCsvAsync(ms);

            Snackbar.Add("Import complete", Severity.Success);
            await OnImported.InvokeAsync();
            Visible = false;
            await VisibleChanged.InvokeAsync(false);
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }
}
