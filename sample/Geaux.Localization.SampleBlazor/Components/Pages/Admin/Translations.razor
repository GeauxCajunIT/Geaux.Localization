@page "/admin/translations"
@layout Geaux.Localization.SampleBlazor.Components.Layouts.AdminLayout

@inject TranslationAdminService Admin
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject IDialogService DialogService

<MudStack Spacing="3">
    <MudPaper Class="pa-4" Elevation="1">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">Translations</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Upload" OnClick="OpenImport">Import</MudButton>
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Download" OnClick="ExportJson">Export JSON</MudButton>
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.FileDownload" OnClick="ExportCsv">Export CSV</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddRow">Add</MudButton>
        </MudStack>

        <MudGrid Class="mt-3" Spacing="2">
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="_tenantId" Label="TenantId (blank = global)" Placeholder="(global)" />
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="_culture" Label="Culture" Placeholder="en-US" />
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="_search" Label="Search (key/value)" />
            </MudItem>
        </MudGrid>

        <MudStack Row="true" Spacing="2" Class="mt-3">
            <MudButton Variant="Variant.Outlined" OnClick="Load" StartIcon="@Icons.Material.Filled.Refresh">Refresh</MudButton>
            <MudButton Variant="Variant.Text" OnClick="ClearFilters">Clear</MudButton>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-2" Elevation="1">
        <MudDataGrid T="Geaux.Localization.Models.Translation"
                     Items="_rows"
                     Dense="true"
                     Hover="true"
                     Bordered="true"
                     Striped="true"
                     Filterable="false"
                     SortMode="SortMode.Multiple"
                     EditMode="DataGridEditMode.Cell"
                     RowEditCommit="OnRowCommit">
            <Columns>
                <PropertyColumn Property="x => x.Id" Title="Id" Editable="false" />
                <PropertyColumn Property="x => x.TenantId" Title="TenantId" />
                <PropertyColumn Property="x => x.Culture" Title="Culture" />
                <PropertyColumn Property="x => x.Key" Title="Key" />
                <PropertyColumn Property="x => x.Value" Title="Value" />
                <TemplateColumn Title="Actions">
                    <CellTemplate>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(()=>Delete(context.Item))" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudPaper>
</MudStack>

@code {
    private List<Geaux.Localization.Models.Translation> _rows = new();

    private string? _tenantId;
    private string? _culture;
    private string? _search;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        var tenant = string.IsNullOrWhiteSpace(_tenantId) ? null : _tenantId;
        _rows = await Admin.ListAsync(tenant, _culture, _search);
    }

    private void ClearFilters()
    {
        _tenantId = null;
        _culture = null;
        _search = null;
    }

    private void AddRow()
    {
        _rows.Insert(0, new Geaux.Localization.Models.Translation
        {
            Id = 0,
            TenantId = string.IsNullOrWhiteSpace(_tenantId) ? null : _tenantId,
            Culture = string.IsNullOrWhiteSpace(_culture) ? "en-US" : _culture!,
            Key = "",
            Value = ""
        });
    }

    private async Task OnRowCommit(Geaux.Localization.Models.Translation item)
    {
        try
        {
            item.TenantId = string.IsNullOrWhiteSpace(item.TenantId) ? null : item.TenantId.Trim();
            item.Culture = (item.Culture ?? "en-US").Trim();
            item.Key = (item.Key ?? "").Trim();
            item.Value ??= "";

            if (string.IsNullOrWhiteSpace(item.Culture) || string.IsNullOrWhiteSpace(item.Key))
            {
                Snackbar.Add("Culture and Key are required.", Severity.Error);
                return;
            }

            if (item.Id == 0)
            {
                var newId = await Admin.CreateAsync(new Geaux.Localization.Models.Translation
                {
                    TenantId = item.TenantId,
                    Culture = item.Culture,
                    Key = item.Key,
                    Value = item.Value
                });
                item.Id = newId;
                Snackbar.Add("Created.", Severity.Success);
            }
            else
            {
                await Admin.UpdateAsync(item);
                Snackbar.Add("Updated.", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private async Task Delete(Geaux.Localization.Models.Translation item)
    {
        if (item.Id == 0)
        {
            _rows.Remove(item);
            return;
        }

        await Admin.DeleteAsync(item.Id);
        Snackbar.Add("Deleted.", Severity.Success);
        await Load();
    }

    private async Task ExportJson()
    {
        var tenant = string.IsNullOrWhiteSpace(_tenantId) ? null : _tenantId;
        var bytes = await Admin.ExportJsonAsync(tenant, _culture, _search);
        await JS.InvokeVoidAsync("downloadFile", $"translations-{DateTime.UtcNow:yyyyMMddHHmmss}.json", "application/json", bytes);
    }

    private async Task ExportCsv()
    {
        var tenant = string.IsNullOrWhiteSpace(_tenantId) ? null : _tenantId;
        var bytes = await Admin.ExportCsvAsync(tenant, _culture, _search);
        await JS.InvokeVoidAsync("downloadFile", $"translations-{DateTime.UtcNow:yyyyMMddHHmmss}.csv", "text/csv", bytes);
    }

    private async Task OpenImport()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true };
        var dialog = DialogService.Show<Geaux.Localization.SampleBlazor.Components.Dialogs.ImportTranslationsDialog>("Import Translations", options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await Load();
        }
    }
}
