@page "/admin/translations"
@using Geaux.Localization.SampleBlazor.Services
@inject TranslationAdminService Admin
@inject ISnackbar Snackbar
@inject DownloadService DownloadSvc

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-0">
    <MudGrid Spacing="2">
        <!-- LEFT: Keys -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-3" Elevation="1">
                <MudText Typo="Typo.h6">Keys</MudText>

                <MudTextField @bind-Value="_search"
                              Placeholder="Search keys..."
                              Immediate="true"
                              Margin="Margin.Dense"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" />

                <MudButton Variant="Variant.Filled"
                           Size="Size.Small"
                           Color="Color.Primary"
                           Class="mt-2"
                           OnClick="LoadKeys">
                    Refresh
                </MudButton>

                <MudList T="string" Dense="true" Class="mt-2" Style="max-height:60vh; overflow:auto;">
                    @foreach (var k in _keys)
                    {
                        <MudListItem T="string"
                                     Value="@k.Key"
                                     Selected="@(_selectedKey == k.Key)"
                                     OnClick="@(() => SelectKey(k.Key))">
                            <MudText>@k.Key</MudText>
                        </MudListItem>
                    }
                </MudList>
                <MudSelect T="string"
                           Dense="true"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Style="min-width: 160px"
                           Value="@(_tenantFilter ?? GlobalTenant)"
                           ValueChanged="OnTenantChanged">

                    <MudSelectItem Value="@GlobalTenant">@GlobalTenant</MudSelectItem>

                    @foreach (var t in _knownTenants)
                    {
                        <MudSelectItem Value="@t">@t</MudSelectItem>
                    }
                </MudSelect>

            </MudPaper>
        </MudItem>

        <!-- RIGHT: Values -->
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-3" Elevation="1">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6">Translations</MudText>

                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Upload"
                                       Size="Size.Small"
                                       OnClick="@(() => _showImport = true)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Download"
                                       Size="Size.Small"
                                       OnClick="ExportCsv" />
                        <MudIconButton Icon="@Icons.Material.Filled.DataObject"
                                       Size="Size.Small"
                                       OnClick="ExportJson" />
                    </MudStack>
                </MudStack>

                @if (string.IsNullOrWhiteSpace(_selectedKey))
                {
                    <MudText Class="mt-4">Select a key on the left.</MudText>
                }
                else
                {
                    <MudText Class="mt-2"><b>Key:</b> @_selectedKey</MudText>

                    <MudTable Items="_rows" Dense="true" Hover="true" Class="mt-3">
                        <HeaderContent>
                            <MudTh>Culture</MudTh>
                            <MudTh>Tenant</MudTh>
                            <MudTh>Value</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>

                        <RowTemplate>
                            <MudTd>@context.Culture</MudTd>
                            <MudTd>@(context.TenantId ?? "(global)")</MudTd>
                            <MudTd Style="width:60%;">
                                <MudTextField @bind-Value="context.Value"
                                              Margin="Margin.Dense" />
                            </MudTd>
                            <MudTd>
                                <MudButton Size="Size.Small"
                                           Variant="Variant.Filled"
                                           OnClick="@(() => Save(context))">
                                    Save
                                </MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

<ImportTranslationsDialog Visible="@_showImport"
                          VisibleChanged="@(v => _showImport = v)"
                          OnImported="ReloadAfterImport" />

@code {
    private string? _search;
    private List<dynamic> _keys = new();
    private string? _selectedKey;
    private bool _showImport;
    private string? _tenantFilter = null; // null = global
    private List<string> _knownTenants = new() { "TenantA", "TenantB" }; // you can load from config later
    private const string GlobalTenant = "(global)";
    private readonly string[] _cultures = new[] { "en-US", "fr-FR" };
    private List<Row> _rows = new();

    protected override async Task OnInitializedAsync()
        => await LoadKeys();

    private async Task LoadKeys()
        => _keys = (await Admin.SearchKeysAsync(_search)).Cast<dynamic>().ToList();

    private async Task SelectKey(string key)
    {
        _selectedKey = key;
        _rows.Clear();

        foreach (var c in _cultures)
        {
            var v = await Admin.GetValueAsync(key, c, null) ?? "";
            _rows.Add(new Row { Culture = c, Value = v });
        }
    }

    private async Task Save(Row row)
    {
        if (_selectedKey == null) return;
        await Admin.UpsertValueAsync(_selectedKey, row.Culture, row.TenantId, row.Value ?? "");
        Snackbar.Add("Saved", Severity.Success);
    }

    private async Task ExportCsv()
    {
        var bytes = await Admin.ExportCsvAsync(_search);
        await DownloadSvc.DownloadAsync("localization.csv", "text/csv", bytes);
    }

    private async Task ExportJson()
    {
        var bytes = await Admin.ExportJsonAsync(_search);
        await DownloadSvc.DownloadAsync("localization.json", "application/json", bytes);
    }

    private async Task ReloadAfterImport()
    {
        await LoadKeys();
        if (_selectedKey != null)
            await SelectKey(_selectedKey);
    }

    private static async Task Download(string name, string type, byte[] bytes)
    {
        // Implement JS download helper if desired
        await Task.CompletedTask;
    }

    private sealed class Row
    {
        public string Culture { get; set; } = "en-US";
        public string? TenantId { get; set; }
        public string? Value { get; set; }
    }

    private async Task OnTenantChanged(string value)
    {
        _tenantFilter = value == GlobalTenant ? null : value;

        if (!string.IsNullOrWhiteSpace(_selectedKey))
            await SelectKey(_selectedKey);
    }

}
