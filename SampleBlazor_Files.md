## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\Geaux.Localization.SampleBlazor.csproj

<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="9.0.11">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Relational" Version="9.0.11" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" Version="9.0.11" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="9.0.11" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="9.0.11">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
      <PackageReference Include="MudBlazor" Version="8.15.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\src\Geaux.Localization.csproj" />
  </ItemGroup>

</Project>



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\Models\Order.cs

using Geaux.Localization.Attributes;

namespace Geaux.Localization.SampleBlazor.Models;

/// <summary>
/// Demo model showing how to use <see cref="LocalizedAttribute"/>.
/// </summary>
public sealed class Order
{
    [Localized("Order.Number", DisplayNameKey = "Order.Number.Display")]
    public string Number { get; set; } = string.Empty;

    [Localized("Order.Customer", DisplayNameKey = "Order.Customer.Display")]
    public string CustomerName { get; set; } = string.Empty;

    [Localized("Order.Total", DisplayNameKey = "Order.Total.Display")]
    public decimal Total { get; set; }

    [Localized("Order.Status",
        DisplayNameKey = "Order.Status.Display",
        DisplayMessageKey = "Order.Status.Message",
        ErrorMessageKey = "Order.Status.Error"
        )]
    public string Status { get; set; } = "Pending";
}



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\Models\Product.cs

using Geaux.Localization.Attributes;

namespace Geaux.Localization.SampleBlazor.Models;

/// <summary>
/// Demo model showing how to use <see cref="LocalizedAttribute"/> for display names and messages.
/// </summary>
public sealed class Product
{
    [Localized("Product.Name", DisplayNameKey = "Product.Name.Display")]
    public string Name { get; set; } = string.Empty;

    [Localized("Product.Sku", DisplayNameKey = "Product.Sku.Display")]
    public string Sku { get; set; } = string.Empty;

    [Localized("Product.Price", DisplayNameKey = "Product.Price.Display")]
    public decimal Price { get; set; }

    [Localized("Product.Description", DisplayNameKey = "Product.Description.Display")]
    public string? Description { get; set; }
}



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs

// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\obj\Debug\net9.0\Geaux.Localization.SampleBlazor.AssemblyInfo.cs

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("Geaux.Localization.SampleBlazor")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+0f6240ddb931c9da78799aa41b43fefc9a1ad802")]
[assembly: System.Reflection.AssemblyProductAttribute("Geaux.Localization.SampleBlazor")]
[assembly: System.Reflection.AssemblyTitleAttribute("Geaux.Localization.SampleBlazor")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generated by the MSBuild WriteCodeFragment class.




## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\obj\Debug\net9.0\Geaux.Localization.SampleBlazor.GlobalUsings.g.cs

// <auto-generated/>
global using Microsoft.AspNetCore.Builder;
global using Microsoft.AspNetCore.Hosting;
global using Microsoft.AspNetCore.Http;
global using Microsoft.AspNetCore.Routing;
global using Microsoft.Extensions.Configuration;
global using Microsoft.Extensions.DependencyInjection;
global using Microsoft.Extensions.Hosting;
global using Microsoft.Extensions.Logging;
global using System;
global using System.Collections.Generic;
global using System.IO;
global using System.Linq;
global using System.Net.Http;
global using System.Net.Http.Json;
global using System.Threading;
global using System.Threading.Tasks;



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\obj\Release\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs

// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\obj\Release\net9.0\Geaux.Localization.SampleBlazor.AssemblyInfo.cs

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("Geaux.Localization.SampleBlazor")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Release")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+19c002cef577c56ad2fcc4763ddce67f8e119b7a")]
[assembly: System.Reflection.AssemblyProductAttribute("Geaux.Localization.SampleBlazor")]
[assembly: System.Reflection.AssemblyTitleAttribute("Geaux.Localization.SampleBlazor")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generated by the MSBuild WriteCodeFragment class.




## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\obj\Release\net9.0\Geaux.Localization.SampleBlazor.GlobalUsings.g.cs

// <auto-generated/>
global using Microsoft.AspNetCore.Builder;
global using Microsoft.AspNetCore.Hosting;
global using Microsoft.AspNetCore.Http;
global using Microsoft.AspNetCore.Routing;
global using Microsoft.Extensions.Configuration;
global using Microsoft.Extensions.DependencyInjection;
global using Microsoft.Extensions.Hosting;
global using Microsoft.Extensions.Logging;
global using System;
global using System.Collections.Generic;
global using System.IO;
global using System.Linq;
global using System.Net.Http;
global using System.Net.Http.Json;
global using System.Threading;
global using System.Threading.Tasks;



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\Services\LocalizedAttributeSeeder.cs

using Geaux.Localization.Attributes;
using Geaux.Localization.Contexts;
using Geaux.Localization.Models;
using Microsoft.EntityFrameworkCore;
using System.Reflection;

namespace Geaux.Localization.SampleBlazor.Services;

public static class LocalizedAttributeSeeder
{
    public static async Task SeedAsync(
        IDbContextFactory<GeauxLocalizationDbContext> factory,
        IEnumerable<Type> modelTypes,
        IEnumerable<string> supportedCultures,
        string? tenantId = null,
        CancellationToken ct = default)
    {
        await using GeauxLocalizationDbContext db = await factory.CreateDbContextAsync(ct);

        string[] cultures = supportedCultures
            .Where(c => !string.IsNullOrWhiteSpace(c))
            .Select(c => c.Trim())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToArray();

        foreach (Type modelType in modelTypes)
        {
            foreach (PropertyInfo prop in modelType.GetProperties(BindingFlags.Public | BindingFlags.Instance))
            {
                LocalizedAttribute? attr = prop.GetCustomAttribute<LocalizedAttribute>();
                if (attr is null) continue;

                // Determine cultures to seed for this attribute
                string[] culturesForAttr = !string.IsNullOrWhiteSpace(attr.Culture)
                    ? new[] { attr.Culture!.Trim() }
                    : cultures;

                // Collect keys to seed (unique)
                HashSet<string> keys = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

                if (!string.IsNullOrWhiteSpace(attr.Key))
                    keys.Add(attr.Key);

                if (!string.IsNullOrWhiteSpace(attr.DisplayNameKey))
                    keys.Add(attr.DisplayNameKey!);

                if (!string.IsNullOrWhiteSpace(attr.DisplayMessageKey))
                    keys.Add(attr.DisplayMessageKey!);

                if (!string.IsNullOrWhiteSpace(attr.ErrorMessageKey))
                    keys.Add(attr.ErrorMessageKey!);

                foreach (string? culture in culturesForAttr)
                {
                    foreach (string key in keys)
                    {
                        // Default seed value: last segment or property name (editable later in admin)
                        string defaultValue = MakeDefaultValue(modelType, prop, key);

                        await UpsertAsync(
                            db,
                            tenantId,
                            culture,
                            key,
                            defaultValue,
                            overwrite: true,
                            ct);
                    }
                }
            }
        }

        await db.SaveChangesAsync(ct);
    }

    private static async Task UpsertAsync(
    GeauxLocalizationDbContext db,
    string? tenantId,
    string culture,
    string key,
    string value,
    bool overwrite,
    CancellationToken ct)
    {
        var existing = await db.Translations.FirstOrDefaultAsync(x =>
            x.TenantId == tenantId &&
            x.Culture == culture &&
            x.Key == key, ct);

        if (existing is null)
        {
            db.Translations.Add(new Translation
            {
                TenantId = tenantId,
                Culture = culture,
                Key = key,
                Value = value
            });
            return;
        }

        if (overwrite || string.IsNullOrWhiteSpace(existing.Value))
        {
            existing.Value = value;
        }
    }


    private static string MakeDefaultValue(Type modelType, PropertyInfo prop, string key)
    {
        // Prefer a readable default:
        // - if key ends with ".Display" or ".Name" etc, use property name
        // - else use the key's last segment as a starter
        string? last = key.Split('.', StringSplitOptions.RemoveEmptyEntries).LastOrDefault();
        if (string.IsNullOrWhiteSpace(last))
            return prop.Name;

        // common patterns
        if (last.Equals("Display", StringComparison.OrdinalIgnoreCase) ||
            last.Equals("Name", StringComparison.OrdinalIgnoreCase) ||
            last.Equals("Label", StringComparison.OrdinalIgnoreCase))
            return prop.Name;

        // If they used the required Key as a semantic identifier, use last segment
        return last;
    }
}



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\Services\TranslationAdminService.cs

using Geaux.Localization.Contexts;
using Geaux.Localization.Models;
using Microsoft.EntityFrameworkCore;
using System.Text;
using System.Text.Json;

namespace Geaux.Localization.SampleBlazor.Services;

public sealed class TranslationAdminService
{
    private readonly IDbContextFactory<GeauxLocalizationDbContext> _factory;

    public TranslationAdminService(IDbContextFactory<GeauxLocalizationDbContext> factory)
        => _factory = factory;

    public async Task<List<LocalizationKey>> SearchKeysAsync(string? search, int take = 200)
    {
        await using GeauxLocalizationDbContext db = await _factory.CreateDbContextAsync();

        IQueryable<LocalizationKey> q = db.LocalizationKeys.AsNoTracking();

        if (!string.IsNullOrWhiteSpace(search))
            q = q.Where(k => k.Key.Contains(search));

        return await q.OrderBy(k => k.Key).Take(take).ToListAsync();
    }

    public async Task<LocalizationKey> GetOrCreateKeyAsync(string key, bool isSystem = true)
    {
        await using GeauxLocalizationDbContext db = await _factory.CreateDbContextAsync();

        LocalizationKey? existing = await db.LocalizationKeys.FirstOrDefaultAsync(k => k.Key == key);
        if (existing != null) return existing;

        var created = new LocalizationKey { Key = key, IsSystem = isSystem };
        db.LocalizationKeys.Add(created);
        await db.SaveChangesAsync();
        return created;
    }

    public async Task<string?> GetValueAsync(string key, string culture, string? tenantId)
    {
        await using GeauxLocalizationDbContext db = await _factory.CreateDbContextAsync();

        return await db.LocalizationValues.AsNoTracking()
            .Where(v => v.LocalizationKey.Key == key &&
                        v.Culture == culture &&
                        v.TenantId == tenantId)
            .Select(v => v.Value)
            .FirstOrDefaultAsync();
    }

    public async Task UpsertValueAsync(string key, string culture, string? tenantId, string value)
    {
        tenantId = string.IsNullOrWhiteSpace(tenantId) ? null : tenantId;

        await using GeauxLocalizationDbContext db = await _factory.CreateDbContextAsync();

        LocalizationKey k = await db.LocalizationKeys.FirstOrDefaultAsync(x => x.Key == key)
            ?? (db.LocalizationKeys.Add(new LocalizationKey { Key = key, IsSystem = true }).Entity);

        await db.SaveChangesAsync(); // ensure key has Id

        LocalizationValue? row = await db.LocalizationValues.FirstOrDefaultAsync(v =>
            v.LocalizationKeyId == k.Id &&
            v.Culture == culture &&
            v.TenantId == tenantId);

        if (row == null)
        {
            db.LocalizationValues.Add(new LocalizationValue
            {
                LocalizationKeyId = k.Id,
                Culture = culture,
                TenantId = tenantId,
                Value = value
            });
        }
        else
        {
            row.Value = value;
        }

        await db.SaveChangesAsync();
    }

    // --- Bulk CSV ---
    // CSV format: Key,Culture,TenantId,Value
    public async Task<byte[]> ExportCsvAsync(string? search = null)
    {
        await using GeauxLocalizationDbContext db = await _factory.CreateDbContextAsync();

        var q = db.LocalizationValues.AsNoTracking()
            .Select(v => new { v.LocalizationKey.Key, v.Culture, v.TenantId, v.Value });

        if (!string.IsNullOrWhiteSpace(search))
            q = q.Where(x => x.Key.Contains(search));

        var rows = await q.OrderBy(x => x.Key).ThenBy(x => x.Culture).ToListAsync();

        var sb = new StringBuilder();
        sb.AppendLine("Key,Culture,TenantId,Value");

        foreach (var r in rows)
        {
            sb.Append(Escape(r.Key)).Append(',')
              .Append(Escape(r.Culture)).Append(',')
              .Append(Escape(r.TenantId ?? "")).Append(',')
              .Append(Escape(r.Value)).AppendLine();
        }

        return Encoding.UTF8.GetBytes(sb.ToString());
    }

    public async Task ImportCsvAsync(Stream csvStream)
    {
        using var reader = new StreamReader(csvStream, Encoding.UTF8, leaveOpen: true);
        var header = await reader.ReadLineAsync(); // Key,Culture,TenantId,Value
        if (header == null) return;

        while (!reader.EndOfStream)
        {
            var line = await reader.ReadLineAsync();
            if (string.IsNullOrWhiteSpace(line)) continue;

            List<string> cols = ParseCsvLine(line);
            if (cols.Count < 4) continue;

            var key = cols[0];
            var culture = cols[1];
            var tenant = string.IsNullOrWhiteSpace(cols[2]) ? null : cols[2];
            var value = cols[3];

            await UpsertValueAsync(key, culture, tenant, value);
        }
    }

    // --- Bulk JSON ---
    // JSON array: [{ "key":"X", "culture":"en-US", "tenantId":null, "value":"..." }]
    public async Task<byte[]> ExportJsonAsync(string? search = null)
    {
        await using GeauxLocalizationDbContext db = await _factory.CreateDbContextAsync();

        var q = db.LocalizationValues.AsNoTracking()
            .Select(v => new { key = v.LocalizationKey.Key, culture = v.Culture, tenantId = v.TenantId, value = v.Value });

        if (!string.IsNullOrWhiteSpace(search))
            q = q.Where(x => x.key.Contains(search));

        var rows = await q.ToListAsync();
        return JsonSerializer.SerializeToUtf8Bytes(rows, new JsonSerializerOptions { WriteIndented = true });
    }

    public async Task ImportJsonAsync(Stream jsonStream)
    {
        List<JsonRow> items = await JsonSerializer.DeserializeAsync<List<JsonRow>>(jsonStream)
                    ?? new();

        foreach (JsonRow i in items)
            await UpsertValueAsync(i.key, i.culture, i.tenantId, i.value);
    }

    private sealed record JsonRow(string key, string culture, string? tenantId, string value);

    private static string Escape(string s)
        => "\"" + s.Replace("\"", "\"\"") + "\"";

    private static List<string> ParseCsvLine(string line)
    {
        var result = new List<string>();
        var sb = new StringBuilder();
        bool inQuotes = false;

        for (int i = 0; i < line.Length; i++)
        {
            var c = line[i];

            if (c == '"')
            {
                if (inQuotes && i + 1 < line.Length && line[i + 1] == '"')
                {
                    sb.Append('"');
                    i++;
                }
                else inQuotes = !inQuotes;
            }
            else if (c == ',' && !inQuotes)
            {
                result.Add(sb.ToString());
                sb.Clear();
            }
            else sb.Append(c);
        }

        result.Add(sb.ToString());
        return result;
    }
}



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\Services\TypedStringLocalizer.cs

using System.Globalization;
using Microsoft.Extensions.Localization;

namespace Geaux.Localization.SampleBlazor.Services;

/// <summary>
/// Typed localizer adapter that resolves a type-scoped <see cref="IStringLocalizer"/> using the registered <see cref="IStringLocalizerFactory"/>.
/// </summary>
/// <typeparam name="T">The resource type.</typeparam>
public sealed class TypedStringLocalizer<T> : IStringLocalizer<T>
{
    private readonly IStringLocalizer _inner;

    /// <summary>
    /// Initializes a new instance of the <see cref="TypedStringLocalizer{T}"/> class.
    /// </summary>
    /// <param name="factory">The localizer factory.</param>
    public TypedStringLocalizer(IStringLocalizerFactory factory)
    {
        _inner = factory.Create(typeof(T));
    }

    /// <inheritdoc />
    public LocalizedString this[string name] => _inner[name];

    /// <inheritdoc />
    public LocalizedString this[string name, params object[] arguments] => _inner[name, arguments];

    /// <inheritdoc />
    public IEnumerable<LocalizedString> GetAllStrings(bool includeParentCultures) => _inner.GetAllStrings(includeParentCultures);

    /// <summary>
    /// Returns a localizer for the specified culture when supported by the underlying implementation.
    /// </summary>
    /// <remarks>
    /// Some versions of <c>Microsoft.Extensions.Localization</c> do not expose <c>WithCulture</c> on the interface.
    /// Geaux's database localizer supports culture scoping; this adapter uses reflection to call it when available.
    /// </remarks>
    public IStringLocalizer WithCulture(CultureInfo culture)
    {
        var method = _inner.GetType().GetMethod("WithCulture", new[] { typeof(CultureInfo) });
        if (method is null)
        {
            return _inner;
        }

        var result = method.Invoke(_inner, new object[] { culture });
        return result as IStringLocalizer ?? _inner;
    }
}



## File: D:\Source\Repos\NuGet Packages\Geaux.Localization\sample\Geaux.Localization.SampleBlazor\Program.cs

using Geaux.Localization.Contexts;
using Geaux.Localization.Extensions;
using Geaux.Localization.SampleBlazor.Components;
using Geaux.Localization.SampleBlazor.Models;
using Geaux.Localization.SampleBlazor.Services;
using Microsoft.AspNetCore.Localization;
using Microsoft.EntityFrameworkCore;
using MudBlazor.Services;
using System.Globalization;

WebApplicationBuilder builder = WebApplication.CreateBuilder(args);

builder.Services.AddMudServices();

builder.Services.AddRazorComponents()
    .AddInteractiveServerComponents();

builder.Services.AddGeauxLocalization(builder.Configuration.GetSection("Localization"));

builder.Services.AddScoped<TranslationAdminService>();

// IMPORTANT: Do NOT hard-set thread culture globally here if you’re relying on RequestLocalization.
// Remove these if you have them:
// CultureInfo.DefaultThreadCurrentCulture = ...
// CultureInfo.DefaultThreadCurrentUICulture = ...

WebApplication app = builder.Build();

app.UseStaticFiles();

app.UseAntiforgery();

// Configure supported cultures
CultureInfo[] supportedCultures = new[]
{
    new CultureInfo("en-US"),
    new CultureInfo("fr-FR")
};

RequestLocalizationOptions localizationOptions = new RequestLocalizationOptions
{
    DefaultRequestCulture = new RequestCulture("en-US"),
    SupportedCultures = supportedCultures,
    SupportedUICultures = supportedCultures,

    // Cookie FIRST so it persists and won’t revert.
    RequestCultureProviders = new List<IRequestCultureProvider>
    {
        new CookieRequestCultureProvider(),
        new QueryStringRequestCultureProvider()
    }
};

app.UseRequestLocalization(localizationOptions);

// Endpoint to set culture cookie and redirect back
app.MapGet("/culture/set", (HttpContext http, string culture, string? returnUrl) =>
{
    if (string.IsNullOrWhiteSpace(culture))
        culture = "en-US";

    RequestCulture requestCulture = new RequestCulture(culture);

    http.Response.Cookies.Append(
        CookieRequestCultureProvider.DefaultCookieName,
        CookieRequestCultureProvider.MakeCookieValue(requestCulture),
        new CookieOptions
        {
            Expires = DateTimeOffset.UtcNow.AddYears(1),
            IsEssential = true,
            Path = "/"
        });

    // Return to same page by default
    if (string.IsNullOrWhiteSpace(returnUrl) || !Uri.IsWellFormedUriString(returnUrl, UriKind.Relative))
        returnUrl = "/";

    return Results.LocalRedirect(returnUrl);
});

app.MapRazorComponents<App>()
   .AddInteractiveServerRenderMode();

await InitializeLocalizationDbAsync(app);

using (IServiceScope scope = app.Services.CreateScope())
{
    IDbContextFactory<GeauxLocalizationDbContext> factory = scope.ServiceProvider.GetRequiredService<IDbContextFactory<GeauxLocalizationDbContext>>();

    await LocalizedAttributeSeeder.SeedAsync(
        factory,
        modelTypes: new[] { typeof(Product), typeof(Order) },
        supportedCultures: new[] { "en-US", "fr-FR" },
        tenantId: null);
}

app.Run();


static async Task InitializeLocalizationDbAsync(WebApplication app)
{
    using IServiceScope scope = app.Services.CreateScope();

    IDbContextFactory<GeauxLocalizationDbContext> factory = scope.ServiceProvider.GetRequiredService<IDbContextFactory<GeauxLocalizationDbContext>>();
    await using GeauxLocalizationDbContext db = await factory.CreateDbContextAsync();

    string provider = db.Database.ProviderName ?? "";
    bool isSqlite = provider.Contains("Sqlite", StringComparison.OrdinalIgnoreCase);
    bool isSqlServer = provider.Contains("SqlServer", StringComparison.OrdinalIgnoreCase);

    if (isSqlite)
    {
        await db.Database.EnsureCreatedAsync();
        return;
    }

    // SQL Server (and others): migrate if migrations exist; otherwise ensure-created
    IEnumerable<string> migrations = db.Database.GetMigrations();
    if (migrations.Any())
        await db.Database.MigrateAsync();
    else
        await db.Database.EnsureCreatedAsync();
}




